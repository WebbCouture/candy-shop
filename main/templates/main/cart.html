{% extends 'base.html' %}

{% block content %}
<section class="cart-page cart-theme-dark" style="max-width: 1200px; margin: 0 auto; padding: 1rem;">
  <h1 class="cart-title" style="text-align: center;">ðŸ›’ Your Shopping Cart</h1>
  <p class="cart-intro" style="text-align: center;">
    Hereâ€™s a quick overview of the treats youâ€™ve picked. You can adjust quantities, remove items, or head to checkout.
    All candies are freshly packed just for you!
  </p>

  {% if items or cart %}
    <div class="cart-grid">
      <!-- Cart items -->
      <ul class="cart-list" role="list">

        {% if items %}
          {% for it in items %}
            <li class="cart-item">
              <div class="item-info">
                <span class="item-name">
                  {{ it.name }}
                  {% if it.is_gift %}<em class="text-sm text-rose-700"> (Gift Certificate)</em>{% endif %}
                </span>
                {% if it.description %}
                  <p class="item-description">{{ it.description }}</p>
                {% else %}
                  <p class="item-description">Delicious and carefully selected sweets to brighten your day.</p>
                {% endif %}

                <div class="item-qty-controls">
                  <form action="{% url 'cart_decrease' it.id %}" method="post" class="inline-form">
                    {% csrf_token %}
                    <button class="qty-btn" title="Decrease" aria-label="Decrease">âˆ’</button>
                  </form>

                  <span class="qty" aria-live="polite">{{ it.quantity }}</span>

                  <form action="{% url 'cart_increase' it.id %}" method="post" class="inline-form">
                    {% csrf_token %}
                    <button class="qty-btn" title="Increase" aria-label="Increase">ï¼‹</button>
                  </form>

                  <form action="{% url 'cart_delete' it.id %}" method="post" class="inline-form">
                    {% csrf_token %}
                    <button class="delete-btn" title="Remove" aria-label="Remove">âœ•</button>
                  </form>
                </div>
              </div>

              <div class="item-pricing">
                <span class="item-unit">Unit: {{ currency }} {{ it.unit_price|floatformat:2 }}</span>
                <span class="item-line">Line: {{ currency }} {{ it.line_total|floatformat:2 }}</span>
              </div>
            </li>
          {% endfor %}
        {% else %}
          {% for product_id, item in cart.items %}
            <li class="cart-item">
              <div class="item-info">
                <span class="item-name">{{ item.name }}</span>
                {% if item.description %}
                  <p class="item-description">{{ item.description }}</p>
                {% else %}
                  <p class="item-description">Delicious and carefully selected sweets to brighten your day.</p>
                {% endif %}

                <div class="item-qty-controls">
                  <form action="{% url 'cart_decrease' product_id %}" method="post" class="inline-form">
                    {% csrf_token %}
                    <button class="qty-btn" title="Decrease" aria-label="Decrease">âˆ’</button>
                  </form>

                  <span class="qty" aria-live="polite">{{ item.quantity }}</span>

                  <form action="{% url 'cart_increase' product_id %}" method="post" class="inline-form">
                    {% csrf_token %}
                    <button class="qty-btn" title="Increase" aria-label="Increase">ï¼‹</button>
                  </form>

                  <form action="{% url 'cart_delete' product_id %}" method="post" class="inline-form">
                    {% csrf_token %}
                    <button class="delete-btn" title="Remove" aria-label="Remove">âœ•</button>
                  </form>
                </div>
              </div>
            </li>
          {% endfor %}
        {% endif %}

      </ul>

      <!-- Summary -->
      <aside class="cart-summary" aria-labelledby="summary-title" style="text-align: center;">
        <h2 id="summary-title">Order Summary</h2>
        <p class="summary-text">Review your order before you proceed to checkout. We promise a smooth and secure payment process.</p>

        {% if items %}
          <p class="summary-line"><span>Subtotal</span><span>{{ currency }} {{ subtotal|floatformat:2 }}</span></p>
          {% if promo %}
            <p class="summary-line">
              <span>Discount ({{ promo.code }})</span>
              <span>- {{ currency }} {{ discount|floatformat:2 }}</span>
            </p>
          {% endif %}
          <p class="summary-line"><span>Shipping</span><span>{{ currency }} {{ shipping|floatformat:2 }}</span></p>
          <hr />
          <p class="summary-line summary-total">
            <span>Total</span>
            <span><strong>{{ currency }} {{ total|floatformat:2 }}</strong></span>
          </p>

          <!-- Coupon form -->
          <form action="{% url 'coupons' %}" method="post" class="coupon-form">
            {% csrf_token %}
            <label for="promo_code">Have a coupon?</label>
            <input type="text" name="code" id="promo_code" placeholder="Enter code" value="{{ promo.code|default:'' }}">
            <button type="submit" class="btn btn-secondary">Apply</button>
          </form>
        {% else %}
          <p class="summary-line"><span>Total Items</span><span>{{ cart|length }}</span></p>
        {% endif %}

        <form action="{% url 'create_checkout_session' %}" method="POST" class="checkout-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary btn-pay-card">ðŸ’³ Pay with Card</button>
        </form>

        <a href="{% url 'product_list' %}" class="btn btn-ghost btn-full">â¬… Continue Shopping</a>

        <p class="summary-note">Shipping calculated at checkout. Free shipping on orders over $50.</p>
      </aside>
    </div>

    <div class="cart-extra-info">
      <h3>Why shop with us?</h3>
      <ul>
        <li>âœ” Fresh candy made daily</li>
        <li>âœ” Secure payment with encryption</li>
        <li>âœ” 30-day happiness guarantee</li>
        <li>âœ” Worldwide delivery</li>
      </ul>
      <p class="cart-tips">Tip: Adding more items may unlock special discounts!</p>
    </div>

  {% else %}
    <div class="empty-cart" style="text-align: center;">
      <div class="empty-emoji" aria-hidden="true">ðŸ§º</div>
      <h2>Your cart is empty</h2>
      <p>Looks like you havenâ€™t added anything yet. Why not browse our delicious collection?</p>
      <a class="btn btn-primary" href="{% url 'product_list' %}">Browse Candies</a>
    </div>
  {% endif %}
</section>

<style>
.cart-item { display:flex; justify-content:space-between; gap:1rem; }
.item-pricing { display:flex; flex-direction:column; text-align:right; min-width: 165px; font-weight:600; }
.item-unit, .item-line { color:#7f1d30; }
.summary-line { display:flex; justify-content:space-between; margin:.35rem 0; }
.summary-total { font-size:1.1rem; }

.inline-form { display:inline; margin:0 .25rem; }
.item-qty-controls { display:flex; align-items:center; gap:.25rem; margin-top:.35rem; flex-wrap: wrap; }
.qty-btn, .delete-btn {
  border: none; cursor: pointer; padding:.25rem .5rem; border-radius:6px;
  font-weight:700; line-height:1; background:#ffb3c6; color:#7f1d30;
}
.qty-btn:hover { background:#ff7b94; }
.delete-btn { background:#ffd6db; color:#7f1d30; }
.delete-btn:hover { background:#ffb3c6; }
.qty { min-width: 1.5rem; text-align:center; font-weight:700; }

.coupon-form { margin-top: 1rem; display:flex; gap:.5rem; flex-wrap:wrap; }
.coupon-form input { flex:1; padding:.35rem; border-radius:6px; border:1px solid #ddd; }
.coupon-form button { padding:.35rem .75rem; border:none; border-radius:6px; background:#7f1d30; color:#fff; cursor:pointer; }
.coupon-form button:hover { background:#a11d3c; }
</style>
{% endblock %}
