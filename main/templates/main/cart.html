{% extends 'base.html' %}
{% load static %}

{% block title %}Your Cart - Candy Shop{% endblock %}

{% block content %}
<section class="cart-page cart-theme-dark">
  <h1 class="cart-title">ðŸ›’ Your Shopping Cart</h1>
  <p class="cart-intro">
    Hereâ€™s a quick overview of the treats youâ€™ve picked. You can adjust quantities, remove items, or head to checkout.
    All candies are freshly packed just for you!
  </p>

  {% if items or cart %}
    <div class="cart-grid">
      <!-- Cart items -->
      <ul class="cart-list" role="list">

        {# Prefer detailed items list (provides prices). Fallback to basic cart if not available. #}
        {% if items %}
          {% for it in items %}
            <li class="cart-item">
              <div class="item-info">
                <span class="item-name">
                  {{ it.name }}
                  {% if it.is_gift %}<em class="text-sm text-rose-700"> (Gift Certificate)</em>{% endif %}
                </span>
                {% if it.description %}
                  <p class="item-description">{{ it.description }}</p>
                {% else %}
                  <p class="item-description">Delicious and carefully selected sweets to brighten your day.</p>
                {% endif %}
                <span class="item-quantity">Quantity: {{ it.quantity }}</span>
              </div>
              <div class="item-pricing">
                <span class="item-unit">Unit: {{ currency }} {{ it.unit_price|floatformat:2 }}</span>
                <span class="item-line">Line: {{ currency }} {{ it.line_total|floatformat:2 }}</span>
              </div>
            </li>
          {% endfor %}
        {% else %}
          {# Fallback: original session cart without price info #}
          {% for product_id, item in cart.items %}
            <li class="cart-item">
              <div class="item-info">
                <span class="item-name">{{ item.name }}</span>
                {% if item.description %}
                  <p class="item-description">{{ item.description }}</p>
                {% else %}
                  <p class="item-description">Delicious and carefully selected sweets to brighten your day.</p>
                {% endif %}
                <span class="item-quantity">Quantity: {{ item.quantity }}</span>
              </div>
            </li>
          {% endfor %}
        {% endif %}

      </ul>

      <!-- Summary -->
      <aside class="cart-summary" aria-labelledby="summary-title">
        <h2 id="summary-title">Order Summary</h2>
        <p class="summary-text">Review your order before you proceed to checkout. We promise a smooth and secure payment process.</p>

        {# Show full money breakdown if we have it; else show item count only #}
        {% if items %}
          <p class="summary-line"><span>Subtotal</span><span>{{ currency }} {{ subtotal|floatformat:2 }}</span></p>
          {% if promo %}
            <p class="summary-line"><span>Discount ({{ promo.code }})</span><span>- {{ currency }} {{ discount|floatformat:2 }}</span></p>
          {% endif %}
          <p class="summary-line"><span>Shipping</span><span>{{ currency }} {{ shipping|floatformat:2 }}</span></p>
          <hr />
          <p class="summary-line summary-total"><span>Total</span><span><strong>{{ currency }} {{ total|floatformat:2 }}</strong></span></p>
        {% else %}
          <p class="summary-line"><span>Total Items</span><span>{{ cart|length }}</span></p>
        {% endif %}

        <form action="{% url 'create_checkout_session' %}" method="POST" class="checkout-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary btn-pay-card">ðŸ’³ Pay with Card</button>
        </form>

        <a href="{% url 'product_list' %}" class="btn btn-ghost btn-full">â¬… Continue Shopping</a>

        <p class="summary-note">Shipping calculated at checkout. Free shipping on orders over $50.</p>
      </aside>
    </div>

    <div class="cart-extra-info">
      <h3>Why shop with us?</h3>
      <ul>
        <li>âœ” Fresh candy made daily</li>
        <li>âœ” Secure payment with encryption</li>
        <li>âœ” 30-day happiness guarantee</li>
        <li>âœ” Worldwide delivery</li>
      </ul>
      <p class="cart-tips">Tip: Adding more items may unlock special discounts!</p>
    </div>

  {% else %}
    <div class="empty-cart">
      <div class="empty-emoji" aria-hidden="true">ðŸ§º</div>
      <h2>Your cart is empty</h2>
      <p>Looks like you havenâ€™t added anything yet. Why not browse our delicious collection?</p>
      <a class="btn btn-primary" href="{% url 'product_list' %}">Browse Candies</a>
    </div>
  {% endif %}
</section>

<style>
/* Minimal helpers to align the new price columns with your existing theme */
.cart-item { display:flex; justify-content:space-between; gap:1rem; }
.item-pricing { display:flex; flex-direction:column; text-align:right; min-width: 165px; font-weight:600; }
.item-unit, .item-line { color:#7f1d30; }
.summary-line { display:flex; justify-content:space-between; margin:.35rem 0; }
.summary-total { font-size:1.1rem; }
</style>
{% endblock %}
