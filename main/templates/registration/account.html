{% extends 'base.html' %}
{% load static %}

{% block title %}
  {% if dashboard %}My Account - Candy Shop{% else %}Login / Register - Candy Shop{% endif %}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12">
  <div class="max-w-4xl mx-auto">

    <!-- WELCOME MESSAGE -->
    <p class="text-center text-xl text-gray-700 mb-12 font-medium">
      Create an account today and receive a <strong class="text-pink-600 font-bold">free candy surprise</strong> delivered right to your door! ðŸŽ‰
    </p>

    {% if dashboard %}
      <!-- LOGGED-IN DASHBOARD -->
      <div class="bg-white rounded-3xl shadow-2xl p-10 border border-pink-100">
        <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-pink-700 text-center mb-8">
          Welcome, {{ request.user.username }}!
        </h1>

        <h2 class="text-3xl font-semibold text-pink-600 text-center mb-8">Your Purchase History</h2>

        {% if orders %}
          <div class="overflow-x-auto rounded-xl shadow-lg">
            <table class="min-w-full bg-white border border-pink-200 rounded-2xl">
              <thead class="bg-gradient-to-r from-pink-100 to-pink-50">
                <tr>
                  <th class="py-4 px-6 text-left text-pink-800 font-bold uppercase tracking-wider">Order #</th>
                  <th class="py-4 px-6 text-left text-pink-800 font-bold uppercase tracking-wider">Date</th>
                  <th class="py-4 px-6 text-left text-pink-800 font-bold uppercase tracking-wider">Items</th>
                  <th class="py-4 px-6 text-left text-pink-800 font-bold uppercase tracking-wider">Total</th>
                </tr>
              </thead>
              <tbody>
                {% for order in orders %}
                <tr class="border-b hover:bg-pink-50 transition duration-200">
                  <td class="py-4 px-6 font-medium">#{{ order.id }}</td>
                  <td class="py-4 px-6 text-gray-600">{{ order.date|date:"M d, Y" }}</td>
                  <td class="py-4 px-6">
                    <ul class="list-disc list-inside text-sm space-y-1">
                      {% for item in order.items.all %}
                      <li class="text-gray-700">{{ item.quantity }} Ã— {{ item.product.name }} â€” ${{ item.price }}</li>
                      {% endfor %}
                    </ul>
                  </td>
                  <td class="py-4 px-6 font-bold text-pink-600 text-lg">${{ order.total }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-center text-gray-500 text-lg py-12">You haven't made any purchases yet.</p>
        {% endif %}

        <!-- LOGOUT BUTTON â€“ GAMMAL STIL BEHÃ…LLEN -->
        <div class="text-center mt-10">
          <form method="post" action="{% url 'logout' %}" class="inline">
            {% csrf_token %}
            <button type="submit" class="logout-btn">
              <span class="logout-btn__icon" aria-hidden="true">Log out</span>
              <span>Log out</span>
            </button>
          </form>
        </div>
      </div>

    {% else %}
      <!-- CENTRERAD LOGIN + REGISTER -->
      <div class="flex justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-10 border border-pink-100 max-w-md w-full">
          <h2 class="text-3xl font-bold text-pink-600 text-center mb-8">Login</h2>
          <form method="post" class="space-y-5">
            {% csrf_token %}
            <input type="hidden" name="login" value="1">
            {{ login_form.as_p }}
            {% if login_form.errors %}
              <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                <ul class="list-disc list-inside text-sm">
                  {% for field in login_form %}
                    {% for error in field.errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold py-3 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-200">
              Login
            </button>
          </form>

          <p class="text-center mt-6 text-sm text-gray-600">
            Don't have an account? <a href="#" id="show-register" class="text-pink-600 font-bold hover:underline">Sign up here</a>
          </p>
          <p class="text-center mt-3 text-sm text-gray-600">
            <a href="{% url 'password_reset' %}" class="text-pink-600 hover:underline">Forgot your password?</a>
          </p>
        </div>
      </div>

      <!-- REGISTER (HIDDEN) -->
      <div class="flex justify-center mt-8">
        <div class="bg-white rounded-3xl shadow-2xl p-10 border border-pink-100 max-w-md w-full" id="signup-form" style="display:none;">
          <h2 class="text-3xl font-bold text-pink-600 text-center mb-8">Create Account</h2>
          <form method="post" class="space-y-5">
            {% csrf_token %}
            <input type="hidden" name="signup" value="1">
            {{ signup_form.as_p }}
            {% if signup_form.errors %}
              <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                <ul class="list-disc list-inside text-sm">
                  {% for field in signup_form %}
                    {% for error in field.errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold py-3 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-200">
              Sign Up
            </button>
          </form>

          <p class="text-center mt-6 text-sm text-gray-600">
            Already have an account? <a href="#" id="show-login" class="text-pink-600 font-bold hover:underline">Login here</a>
          </p>
        </div>
      </div>
    {% endif %}

  </div>
</div>

<!-- TOGGLE SCRIPT -->
<script>
  document.getElementById("show-register").addEventListener("click", function(e){
    e.preventDefault();
    document.querySelector(".flex.justify-center > .bg-white").style.display = "none";
    document.getElementById("signup-form").parentElement.style.display = "flex";
  });

  document.getElementById("show-login").addEventListener("click", function(e){
    e.preventDefault();
    document.getElementById("signup-form").parentElement.style.display = "none";
    document.querySelector(".flex.justify-center > .bg-white").style.display = "block";
  });
</script>

<!-- GAMLA STILEN FÃ–R LOGOUT-KNAPPEN -->
<style>
  .logout-btn {
    --candy-start: #ff7b94;
    --candy-end:   #ff4d6d;
    --candy-glow:  rgba(255, 77, 109, 0.45);

    display: inline-flex;
    align-items: center;
    gap: 10px;

    padding: 12px 28px;
    border: 0;
    border-radius: 999px;

    color: #fff;
    font-weight: 800;
    letter-spacing: .3px;

    background: linear-gradient(135deg, var(--candy-start), var(--candy-end));
    box-shadow: 0 10px 20px var(--candy-glow);
    cursor: pointer;

    transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    position: relative;
    overflow: hidden;
  }

  .logout-btn::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
    transform: translateX(-120%);
    transition: transform .6s ease;
  }

  .logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 26px var(--candy-glow);
    filter: saturate(1.05);
  }

  .logout-btn:hover::after {
    transform: translateX(120%);
  }

  .logout-btn:active {
    transform: translateY(0);
    box-shadow: 0 8px 16px var(--candy-glow);
  }

  .logout-btn:focus-visible {
    outline: 3px solid #ffd0da;
    outline-offset: 3px;
  }

  .logout-btn__icon {
    font-size: 1.15rem;
    line-height: 1;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,.15));
  }
</style>
{% endblock %}