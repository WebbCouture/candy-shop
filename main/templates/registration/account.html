{% extends 'base.html' %}

{% block content %}
  <div class="container">
    <h1>ðŸ‘¤ Account</h1>

    <!-- Welcome message -->
    <p style="font-size: 1.2rem; color: #444; margin-bottom: 20px;">
      Create an account today and receive a <strong>free candy surprise</strong> delivered right to your door! ðŸŽ‰
    </p>
    
    {% if dashboard %}
      <!-- Logged-in Dashboard -->
      <div class="account-dashboard">
        <p>Welcome, <strong>{{ request.user.username }}</strong>!</p>

        <h3>Your Purchase History</h3>
        {% if orders %}
          <div class="table-responsive">
            <table class="table table-striped table-bordered purchase-history-table">
              <thead class="table-dark">
                <tr>
                  <th>Order #</th>
                  <th>Date</th>
                  <th>Items</th>
                  <th>Total (USD)</th>
                </tr>
              </thead>
              <tbody>
                {% for order in orders %}
                  <tr>
                    <td data-label="Order #">{{ order.id }}</td>
                    <td data-label="Date">{{ order.date|date:"Y-m-d H:i" }}</td>
                    <td data-label="Items">
                      <ul class="mb-0">
                        {% for item in order.items.all %}
                          <li>{{ item.quantity }} Ã— {{ item.product.name }} â€” ${{ item.price }}</li>
                        {% endfor %}
                      </ul>
                    </td>
                    <td data-label="Total"><strong>${{ order.total }}</strong></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>You haven't made any purchases yet.</p>
        {% endif %}

        <!-- Stylish Logout Button -->
        <form method="post" action="{% url 'logout' %}" class="mt-3">
          {% csrf_token %}
          <button type="submit" class="logout-btn">
            <span class="logout-btn__icon" aria-hidden="true">ðŸšª</span>
            <span>Log out</span>
          </button>
        </form>
      </div>

    {% else %}
      <!-- Login & Sign Up -->
      <div id="login-form" class="account-form">
        <h3>Login</h3>
        <form method="post">
          {% csrf_token %}
          {{ login_form.as_p }}
          {% if login_form.errors %}
            <div class="alert alert-danger mt-2">
              <ul class="mb-0">
                {% for field in login_form %}
                  {% for error in field.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <button type="submit" name="login" class="btn btn-primary">Login</button>
        </form>
        <p>Don't have an account? <a href="#" id="show-register">Sign up here</a></p>
        <p><a href="{% url 'password_reset' %}">Forgot your password?</a></p>
      </div>

      <div id="signup-form" class="account-form" style="display:none;">
        <h3>Sign Up</h3>
        <form method="post">
          {% csrf_token %}
          {{ signup_form.as_p }}
          {% if signup_form.errors %}
            <div class="alert alert-danger mt-2">
              <ul class="mb-0">
                {% for field in signup_form %}
                  {% for error in field.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <button type="submit" name="signup" class="btn btn-primary">Sign Up</button>
        </form>
        <p>Already have an account? <a href="#" id="show-login">Login here</a></p>
      </div>
    {% endif %}
  </div>

  <style>
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background-color: transparent; /* No background */
    }

    .purchase-history-table th, .purchase-history-table td {
      padding: 12px;
      text-align: left;
    }

    .purchase-history-table {
      width: 100%;
      border-collapse: collapse;
    }

    .purchase-history-table th {
      background-color: #f1f1f1;
    }

    .alert {
      padding: 10px;
      background-color: #f8d7da;
      color: #721c24;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    /* === Stylish Logout Button === */
    .logout-btn {
      --candy-start: #ff7b94;
      --candy-end:   #ff4d6d;
      --candy-glow:  rgba(255, 77, 109, 0.45);

      display: inline-flex;
      align-items: center;
      gap: 10px;

      padding: 12px 28px;
      border: 0;
      border-radius: 999px;

      color: #fff;
      font-weight: 800;
      letter-spacing: .3px;

      background: linear-gradient(135deg, var(--candy-start), var(--candy-end));
      box-shadow: 0 10px 20px var(--candy-glow);
      cursor: pointer;

      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      position: relative;
      overflow: hidden;
    }

    .logout-btn::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
      transform: translateX(-120%);
      transition: transform .6s ease;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 26px var(--candy-glow);
      filter: saturate(1.05);
    }

    .logout-btn:hover::after {
      transform: translateX(120%);
    }

    .logout-btn:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px var(--candy-glow);
    }

    .logout-btn:focus-visible {
      outline: 3px solid #ffd0da;
      outline-offset: 3px;
    }

    .logout-btn__icon {
      font-size: 1.15rem;
      line-height: 1;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.15));
    }
  </style>

  <script>
    document.getElementById("show-register").addEventListener("click", function(e){
      e.preventDefault();
      document.getElementById("login-form").style.display = "none";
      document.getElementById("signup-form").style.display = "block";
    });

    document.getElementById("show-login").addEventListener("click", function(e){
      e.preventDefault();
      document.getElementById("signup-form").style.display = "none";
      document.getElementById("login-form").style.display = "block";
    });
  </script>

{% endblock %}
